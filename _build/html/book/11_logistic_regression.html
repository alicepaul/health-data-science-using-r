

<!DOCTYPE html>


<html data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>11. Logistic Regression &#8212; R for Health Data Science</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'book/11_logistic_regression';</script>
    <link rel="canonical" href="https://alicepaul.github.io/r-for-health-data-science/book/11_logistic_regression.html" />
    <link rel="shortcut icon" href="../_static/fav.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="12. Writing Reports with R Markdown" href="12_rmarkdown_reports.html" />
    <link rel="prev" title="10. Linear Regression" href="10_linear_regression.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction to R</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="1_intro_to_r.html">1. Intro to R, RStudio, and Jupyter Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_data_structures.html">2. Data Structures in R</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_data_files.html">3. Working with Data Files in R</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Exploratory Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="4_exploratory_analysis.html">4. Intro to Exploratory Data Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_data_transformations_summaries.html">5. Data Transformations and Summaries</a></li>
<li class="toctree-l1"><a class="reference internal" href="6_merging_data.html">6. Merging and Reshaping Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="7_visualization_ggplot.html">7. Visualization with ggplot2</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Distributions and Hypothesis Testing</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="8_distributions.html">8. Probability Distributions and Random Variables in R</a></li>
<li class="toctree-l1"><a class="reference internal" href="9_hypothesis_tests.html">9. Hypothesis Testing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Regression</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="10_linear_regression.html">10. Linear Regression</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">11. Logistic Regression</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Extra Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="12_rmarkdown_reports.html">12. Writing Reports with R Markdown</a></li>

<li class="toctree-l1"><a class="reference internal" href="13_expanding_r_skills.html">13. Expanding your R Skills</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/alicepaul/r-for-health-data-science/master?urlpath=tree/book/11_logistic_regression.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>



<a href="https://github.com/alicepaul/r-for-health-data-science" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/book/11_logistic_regression.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>11. Logistic Regression</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generalized-linear-models-in-r">Generalized Linear Models in R</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#residuals-discrimination-and-calibration">Residuals, Discrimination, and Calibration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#variable-selection">Variable Selection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises:</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="logistic-regression">
<h1>11. Logistic Regression<a class="headerlink" href="#logistic-regression" title="Permalink to this headline">#</a></h1>
<p>This chapter will build on the last and continue with regression in R. In this chapter, we will cover binary logistic regression using the <code class="docutils literal notranslate"><span class="pre">glm()</span></code> function, which can be used to fit generalized linear models. Many of the functions learned in the last chapter can also be used with a <code class="docutils literal notranslate"><span class="pre">glm</span></code> object. For example, the <code class="docutils literal notranslate"><span class="pre">glm()</span></code> function expects a formula in the same way as the <code class="docutils literal notranslate"><span class="pre">lm()</span></code> function. We will also cover diagnostic plots and model evaluation specific to a binary outcome.</p>
<p>The data used in this chapter is from the 2021 National Youth Tobacco Survey (NYTS). This dataset contains 20,413 participants and a set of variables relating to demographic information, frequency of tobacco use, and methods of obtaining said tobacco as reported by students on the 2021 NYTS. We will use logistic regression to examine whether survey setting was associated with youth reporting of current tobacco use similar to the analysis presented in <a class="reference external" href="https://pubmed.ncbi.nlm.nih.gov/36470692/">Park-Lee et al. (2023). Impact of Survey Setting on Current Tobacco Product Use: National Youth Tobacco Survey, 2021. Journal of Adolescent Health, 72(3), 365-374</a>. Note that we ignore survey weights for this analysis.</p>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">broom</span></code> package again to present the estimated coefficients, the <code class="docutils literal notranslate"><span class="pre">tidyverse</span></code> package to demonstrate calibration plots, and the <code class="docutils literal notranslate"><span class="pre">pROC</span></code> package to create receiver operating characteristic curves.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">broom</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">pROC</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">RforHDSdata</span><span class="p">)</span>
<span class="nf">data</span><span class="p">(</span><span class="n">nyts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>── <span class=" -Color -Color-Bold">Attaching core tidyverse packages</span> ──────────────────────── tidyverse 2.0.0 ──
<span class=" -Color -Color-Green">✔</span> <span class=" -Color -Color-Blue">dplyr    </span> 1.1.2     <span class=" -Color -Color-Green">✔</span> <span class=" -Color -Color-Blue">readr    </span> 2.1.4
<span class=" -Color -Color-Green">✔</span> <span class=" -Color -Color-Blue">forcats  </span> 1.0.0     <span class=" -Color -Color-Green">✔</span> <span class=" -Color -Color-Blue">stringr  </span> 1.5.0
<span class=" -Color -Color-Green">✔</span> <span class=" -Color -Color-Blue">ggplot2  </span> 3.4.2     <span class=" -Color -Color-Green">✔</span> <span class=" -Color -Color-Blue">tibble   </span> 3.2.1
<span class=" -Color -Color-Green">✔</span> <span class=" -Color -Color-Blue">lubridate</span> 1.9.2     <span class=" -Color -Color-Green">✔</span> <span class=" -Color -Color-Blue">tidyr    </span> 1.3.0
<span class=" -Color -Color-Green">✔</span> <span class=" -Color -Color-Blue">purrr    </span> 1.0.1     
── <span class=" -Color -Color-Bold">Conflicts</span> ────────────────────────────────────────── tidyverse_conflicts() ──
<span class=" -Color -Color-Red">✖</span> <span class=" -Color -Color-Blue">dplyr</span>::<span class=" -Color -Color-Green">filter()</span> masks <span class=" -Color -Color-Blue">stats</span>::filter()
<span class=" -Color -Color-Red">✖</span> <span class=" -Color -Color-Blue">dplyr</span>::<span class=" -Color -Color-Green">lag()</span>    masks <span class=" -Color -Color-Blue">stats</span>::lag()
<span class=" -Color -Color-Cyan">ℹ</span> Use the conflicted package (<span class=" -Color -Color-Blue">&lt;http://conflicted.r-lib.org/&gt;</span>) to force all conflicts to become errors
Type &#39;citation(&quot;pROC&quot;)&#39; for a citation.


Attaching package: ‘pROC’


The following objects are masked from ‘package:stats’:

    cov, smooth, var
</pre></div>
</div>
</div>
</div>
<section id="generalized-linear-models-in-r">
<h2>Generalized Linear Models in R<a class="headerlink" href="#generalized-linear-models-in-r" title="Permalink to this headline">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">glm(formula,</span> <span class="pre">data,</span> <span class="pre">family)</span></code> function in R is used to fit generalized linear models. The three main arguments we must specify to the function are the</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">formula</span></code> - specifies the relationship between the independent variables and the outcome of interest,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code> - the dataset used to train the model, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">family</span></code> - a description of the error distribution and link function to be used in the model.</p></li>
</ul>
<p>In binary logistic regression, we assume a binomial outcome and use the logit link function. We can specify this by setting <code class="docutils literal notranslate"><span class="pre">family</span> <span class="pre">=</span> <span class="pre">bimnomial</span></code>. By default, this will assume the link function is the logit function. We can even use the <code class="docutils literal notranslate"><span class="pre">glm()</span></code> function to implement linear regression by setting <code class="docutils literal notranslate"><span class="pre">family</span> <span class="pre">=</span> <span class="pre">gaussian</span></code>.</p>
<p>TODO: should I add assumptions and form again?</p>
<p>Our outcome of interest will be current e-cigarette use, <code class="docutils literal notranslate"><span class="pre">e_cig_use</span></code>. We need to create this variable from the variables currently in the data. We set <code class="docutils literal notranslate"><span class="pre">e_cig_use</span></code> to 0 if the respondent answered that they have not used e-cigarettes in the last 30 days and 1 otherwise. We can see that there are only 1,435 respondents who reported e-cigarette use. This is a low percentage of overall population and will likely impact our results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">nyts</span><span class="o">$</span><span class="n">e_cig_use</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.factor</span><span class="p">(</span><span class="nf">ifelse</span><span class="p">(</span><span class="n">nyts</span><span class="o">$</span><span class="n">num_e_cigs</span><span class="o">==</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">))</span>
<span class="nf">table</span><span class="p">(</span><span class="n">nyts</span><span class="o">$</span><span class="n">e_cig_use</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    0     1 
18683  1435 
</pre></div>
</div>
</div>
</div>
<p>Looking at the covariate of interest, survey setting, we can see that there are 85 respondents that took the survey in “Some other place”. We will simplify this variable to have two levels: “school” and “home/other”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">table</span><span class="p">(</span><span class="n">nyts</span><span class="o">$</span><span class="n">location</span><span class="p">)</span>
<span class="n">nyts</span><span class="o">$</span><span class="n">location</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.factor</span><span class="p">(</span><span class="nf">ifelse</span><span class="p">(</span><span class="n">nyts</span><span class="o">$</span><span class="n">location</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;In a school building/classroom&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;school&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;home/other&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>    At home (virtual learning) In a school building/classroom 
                          8738                          10737 
              Some other place 
                            85 
</pre></div>
</div>
</div>
</div>
<p>To start, we will create a model to predict e-cigarette use from school setting and identified covariates sex, school level, and race and ethnicity. We use the <code class="docutils literal notranslate"><span class="pre">summary()</span></code> function again to get a summary of this model. The output has slightly changed. Now, we see the null and residual deviances are reported along with the AIC. Adding transformations and interactions is equivalent to in the <code class="docutils literal notranslate"><span class="pre">lm()</span></code> function and is not demonstrated in this chapter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">mod_start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">glm</span><span class="p">(</span><span class="n">e_cig_use</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">grade</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">race_and_ethnicity</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">location</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nyts</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binomial</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">mod_start</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Call:
glm(formula = e_cig_use ~ grade + sex + race_and_ethnicity + 
    location, family = binomial, data = nyts)

Coefficients:
                                          Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)                               -4.60174    0.15388 -29.905  &lt; 2e-16
grade7th                                   0.44606    0.17532   2.544 0.010951
grade8th                                   0.96768    0.16071   6.021 1.73e-09
grade9th                                   1.38300    0.15494   8.926  &lt; 2e-16
grade10th                                  1.91832    0.15132  12.677  &lt; 2e-16
grade11th                                  2.13852    0.14913  14.340  &lt; 2e-16
grade12th                                  2.42858    0.14916  16.282  &lt; 2e-16
gradeUngraded or Other Grade               2.52132    0.44875   5.619 1.93e-08
sexFemale                                  0.19221    0.05795   3.316 0.000912
race_and_ethnicitynon-Hispanic Black      -0.66139    0.11209  -5.900 3.63e-09
race_and_ethnicitynon-Hispanic other race -0.10205    0.15152  -0.674 0.500606
race_and_ethnicitynon-Hispanic White       0.19835    0.07388   2.685 0.007260
locationschool                             0.72234    0.06484  11.141  &lt; 2e-16
                                             
(Intercept)                               ***
grade7th                                  *  
grade8th                                  ***
grade9th                                  ***
grade10th                                 ***
grade11th                                 ***
grade12th                                 ***
gradeUngraded or Other Grade              ***
sexFemale                                 ***
race_and_ethnicitynon-Hispanic Black      ***
race_and_ethnicitynon-Hispanic other race    
race_and_ethnicitynon-Hispanic White      ** 
locationschool                            ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 9754.9  on 18746  degrees of freedom
Residual deviance: 8886.8  on 18734  degrees of freedom
  (1666 observations deleted due to missingness)
AIC: 8912.8

Number of Fisher Scoring iterations: 6
</pre></div>
</div>
</div>
</div>
<p>We can use the <code class="docutils literal notranslate"><span class="pre">tidy()</span></code> function from the broom package to display the estimated coefficients. This time we add the <code class="docutils literal notranslate"><span class="pre">exponentiate</span> <span class="pre">=</span> <span class="pre">TRUE</span></code> argument to exponentiate our coefficients so we can interpret them as change in odds rather than log odds. For example, those who answered at school had double the estimated odds of reporting e-cigarette use compared to those who took the survey at home/other, adjusting for grade, sex, and race and ethnicity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">tidy</span><span class="p">(</span><span class="n">mod_start</span><span class="p">,</span><span class="w"> </span><span class="n">exponentiate</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A tibble: 13 × 5</caption>
<thead>
	<tr><th scope=col>term</th><th scope=col>estimate</th><th scope=col>std.error</th><th scope=col>statistic</th><th scope=col>p.value</th></tr>
	<tr><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>(Intercept)                              </td><td> 0.01003438</td><td>0.15387671</td><td>-29.9053614</td><td>1.676009e-196</td></tr>
	<tr><td>grade7th                                 </td><td> 1.56214571</td><td>0.17532017</td><td>  2.5442613</td><td> 1.095091e-02</td></tr>
	<tr><td>grade8th                                 </td><td> 2.63183465</td><td>0.16071349</td><td>  6.0211574</td><td> 1.731743e-09</td></tr>
	<tr><td>grade9th                                 </td><td> 3.98684862</td><td>0.15493973</td><td>  8.9260584</td><td> 4.414575e-19</td></tr>
	<tr><td>grade10th                                </td><td> 6.80953207</td><td>0.15132448</td><td> 12.6768878</td><td> 7.942319e-37</td></tr>
	<tr><td>grade11th                                </td><td> 8.48684826</td><td>0.14913207</td><td> 14.3397574</td><td> 1.234864e-46</td></tr>
	<tr><td>grade12th                                </td><td>11.34276395</td><td>0.14915563</td><td> 16.2821876</td><td> 1.320624e-59</td></tr>
	<tr><td>gradeUngraded or Other Grade             </td><td>12.44503967</td><td>0.44874868</td><td>  5.6185616</td><td> 1.925538e-08</td></tr>
	<tr><td>sexFemale                                </td><td> 1.21192205</td><td>0.05795494</td><td>  3.3165000</td><td> 9.115260e-04</td></tr>
	<tr><td>race_and_ethnicitynon-Hispanic Black     </td><td> 0.51613544</td><td>0.11209354</td><td> -5.9003049</td><td> 3.628303e-09</td></tr>
	<tr><td>race_and_ethnicitynon-Hispanic other race</td><td> 0.90298050</td><td>0.15151994</td><td> -0.6735372</td><td> 5.006056e-01</td></tr>
	<tr><td>race_and_ethnicitynon-Hispanic White     </td><td> 1.21938504</td><td>0.07388086</td><td>  2.6846828</td><td> 7.259868e-03</td></tr>
	<tr><td>locationschool                           </td><td> 2.05924576</td><td>0.06483696</td><td> 11.1408642</td><td> 7.934559e-29</td></tr>
</tbody>
</table>
</div></div>
</div>
</section>
<section id="residuals-discrimination-and-calibration">
<h2>Residuals, Discrimination, and Calibration<a class="headerlink" href="#residuals-discrimination-and-calibration" title="Permalink to this headline">#</a></h2>
<p>Next we look at the distribution of the residuals. The <code class="docutils literal notranslate"><span class="pre">resid()</span></code> function can be used to find the residuals again, but this time we might want to specify the Pearson and deviance residuals by specifying the <code class="docutils literal notranslate"><span class="pre">type</span></code> argument. We plot the histogram for both of these residual types below. In both plots, we can observe a multi-modal distribution, which reflects the binary nature of our outcome.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">))</span>
<span class="nf">hist</span><span class="p">(</span><span class="nf">resid</span><span class="p">(</span><span class="n">mod_start</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s">&quot;pearson&quot;</span><span class="p">))</span>
<span class="nf">hist</span><span class="p">(</span><span class="nf">resid</span><span class="p">(</span><span class="n">mod_start</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s">&quot;deviance&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f84aa912a48eefc01ba2d20cdd1d66118355f4d4122642c6a7d34e295397fa70.png" src="../_images/f84aa912a48eefc01ba2d20cdd1d66118355f4d4122642c6a7d34e295397fa70.png" />
</div>
</div>
<p>To further evaluate the fit of our model, we may want to observe the predicted probabilities. The <code class="docutils literal notranslate"><span class="pre">predict()</span></code> function by default will return the predicted value on the scale of the linear predictors. In this case, that is the predicted log odds. If want to find the predicted probabilities, we can update the argument <code class="docutils literal notranslate"><span class="pre">type=&quot;response&quot;</span></code>. Additionally, we can predict on data not used to train the model by using the argument <code class="docutils literal notranslate"><span class="pre">newdata</span></code>. Note that there are only 18,747 predicted probabilities despite our training data having more observations. This is because the <code class="docutils literal notranslate"><span class="pre">glm()</span></code> function (and <code class="docutils literal notranslate"><span class="pre">lm()</span></code> function) drop any observations with NA values when training.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">pred_probs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">mod_start</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s">&quot;response&quot;</span><span class="p">)</span>
<span class="nf">length</span><span class="p">(</span><span class="n">pred_probs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">18747</div></div>
</div>
<p>If want to find the class for each observation used in training, we can use the model’s output, which stores the model matrix <code class="docutils literal notranslate"><span class="pre">x</span></code> and the outcome vector <code class="docutils literal notranslate"><span class="pre">y</span></code>. We plot the distribution of estimated probabilities for each class. Note that all the predicted probabilities are below 0.5, the typical cut-off for prediction. This is in part due to the fact that we have such an imbalanced outcome.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">geom_histogram</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">pred_probs</span><span class="p">,</span><span class="w"> </span><span class="n">fill</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">mod_start</span><span class="o">$</span><span class="n">y</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.
</pre></div>
</div>
<img alt="../_images/15b21584a0824f363786e3a0a21790c1ec6120d50359a8d140315c2be7021e3c.png" src="../_images/15b21584a0824f363786e3a0a21790c1ec6120d50359a8d140315c2be7021e3c.png" />
</div>
</div>
<p>We now plot the receiver operating characteristic (ROC) curve and to compute the area under the curve (AUC). The <code class="docutils literal notranslate"><span class="pre">roc()</span></code> function from the <code class="docutils literal notranslate"><span class="pre">pROC</span></code> package builds an ROC curve. The function has several ways to specify a response and predictor. For example, we can specify the response vector <code class="docutils literal notranslate"><span class="pre">response</span></code> and predictor vector <code class="docutils literal notranslate"><span class="pre">predictor</span></code>. By default, with a 0/1 outcome, the <code class="docutils literal notranslate"><span class="pre">roc()</span></code> function will assume class 0 is controls and class 1 is cases. We can also specify this in the <code class="docutils literal notranslate"><span class="pre">levels</span></code> argument to specify the value of the response for controls and cases, respectively. Additionally, the function assumes the predictor vector specifies predicted probabilities for the class 1. We can change the argument <code class="docutils literal notranslate"><span class="pre">direction</span> <span class="pre">=</span> <span class="pre">&gt;</span></code> if the opposite is true. We can plot the ROC curve by calling the <code class="docutils literal notranslate"><span class="pre">plot()</span></code> function. We can add some extra information by adding the AUC (<code class="docutils literal notranslate"><span class="pre">print.auc</span> <span class="pre">=</span> <span class="pre">TRUE</span></code>) and the threshold that maximizes sensitivity + specificity (<code class="docutils literal notranslate"><span class="pre">print.thres</span> <span class="pre">=</span> <span class="pre">TRUE</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">roc_mod</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">roc</span><span class="p">(</span><span class="n">predictor</span><span class="o">=</span><span class="n">pred_probs</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">mod_start</span><span class="o">$</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&lt;&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">roc_mod</span><span class="p">,</span><span class="w"> </span><span class="n">print.auc</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">print.thres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a60d5e353c6b339795657a8f79b699eaf142475a8e680edfbe6a9731684e49bd.png" src="../_images/a60d5e353c6b339795657a8f79b699eaf142475a8e680edfbe6a9731684e49bd.png" />
</div>
</div>
<p>If we want to understand more about the curve, we can use the <code class="docutils literal notranslate"><span class="pre">coords()</span></code> function to find the coordinates for each threshold used. The argument <code class="docutils literal notranslate"><span class="pre">x=</span> <span class="pre">&quot;all&quot;</span></code> specifies we want to find all thresholds but we could also specify only to return local maxima.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">roc_vals</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">coords</span><span class="p">(</span><span class="n">roc</span><span class="o">=</span><span class="n">roc_mod</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;all&quot;</span><span class="p">)</span>
<span class="nf">head</span><span class="p">(</span><span class="n">roc_vals</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 6 × 3</caption>
<thead>
	<tr><th></th><th scope=col>threshold</th><th scope=col>specificity</th><th scope=col>sensitivity</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>1</th><td>       -Inf</td><td>0.000000000</td><td>1.0000000</td></tr>
	<tr><th scope=row>2</th><td>0.005694962</td><td>0.005233795</td><td>1.0000000</td></tr>
	<tr><th scope=row>3</th><td>0.007131542</td><td>0.010697648</td><td>1.0000000</td></tr>
	<tr><th scope=row>4</th><td>0.008502529</td><td>0.015471329</td><td>0.9985294</td></tr>
	<tr><th scope=row>5</th><td>0.009344669</td><td>0.018347041</td><td>0.9977941</td></tr>
	<tr><th scope=row>6</th><td>0.009822271</td><td>0.024040950</td><td>0.9963235</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>We could use this information to find the threshold for sensitivity to be above 0.75. A threshold of 0.062 is the highest threshold with sensitivity above 0.75 and sensitivity 0.55.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">roc_vals</span><span class="p">[</span><span class="n">roc_vals</span><span class="o">$</span><span class="n">sensitivity</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0.75</span><span class="p">,</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="nf">tail</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A data.frame: 1 × 3</caption>
<thead>
	<tr><th></th><th scope=col>threshold</th><th scope=col>specificity</th><th scope=col>sensitivity</th></tr>
	<tr><th></th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><th scope=row>63</th><td>0.06201043</td><td>0.5551274</td><td>0.7676471</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>We will use the threshold of 0.080 indicates on our ROC curve to create predicted classes for our response. By comparing to our outcome using the <code class="docutils literal notranslate"><span class="pre">table()</span></code> function, we can directly calculate the sensitivity, specificity, and overall accuracy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">pred_ys</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">pred_probs</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0.08</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="n">tab_outcome</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">table</span><span class="p">(</span><span class="n">mod_start</span><span class="o">$</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">pred_ys</span><span class="p">)</span>
<span class="n">tab_outcome</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>   pred_ys
        0     1
  0 11992  5395
  1   455   905
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">sens</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tab_outcome</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">tab_outcome</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">]</span><span class="o">+</span><span class="n">tab_outcome</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">])</span>
<span class="nf">round</span><span class="p">(</span><span class="n">sens</span><span class="p">,</span><span class="w"> </span><span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.665</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">spec</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">tab_outcome</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">tab_outcome</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">]</span><span class="o">+</span><span class="n">tab_outcome</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">])</span>
<span class="n">spec</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.689710703399091</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">acc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">tab_outcome</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">]</span><span class="o">+</span><span class="n">tab_outcome</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">])</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">tab_outcome</span><span class="p">)</span>
<span class="n">acc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.687950072011522</div></div>
</div>
<p>Another useful plot is a calibration plot. This type of plot groups the data by the estimated probabilities and compares the mean probability with the observed percentage of observations in class 1. In a sense, it visualizes how close our estimated distribution and true distribution are to each other. There are several packages that can create calibration plots, but we demonstrate how to do this using the tidyverse packages. First, we create a data frame with the predicted probabilities and outcome. Additionally, we group this data into <code class="docutils literal notranslate"><span class="pre">num_cuts</span></code> groups based on the predicted probabilities. Then, we find the estimated mean and standard error within each group along with the observed proportion.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">num_cuts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">10</span>
<span class="n">calib_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">  </span><span class="nf">data.frame</span><span class="p">(</span><span class="n">prob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pred_probs</span><span class="p">,</span>
<span class="w">                          </span><span class="n">bin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">cut</span><span class="p">(</span><span class="n">pred_probs</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">num_cuts</span><span class="p">),</span>
<span class="w">                          </span><span class="n">class</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mod_start</span><span class="o">$</span><span class="n">y</span><span class="p">)</span>
<span class="n">calib_data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">calib_data</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">             </span><span class="nf">group_by</span><span class="p">(</span><span class="n">bin</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">             </span><span class="nf">summarize</span><span class="p">(</span><span class="n">observed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">class</span><span class="p">)</span><span class="o">/</span><span class="nf">n</span><span class="p">(),</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span><span class="o">/</span><span class="nf">n</span><span class="p">(),</span><span class="w"> </span><span class="n">se</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">(</span><span class="n">expected</span><span class="o">*</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">expected</span><span class="p">)</span><span class="o">/</span><span class="nf">n</span><span class="p">()))</span>
<span class="nf">head</span><span class="p">(</span><span class="n">calib_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A tibble: 6 × 4</caption>
<thead>
	<tr><th scope=col>bin</th><th scope=col>observed</th><th scope=col>expected</th><th scope=col>se</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;dbl&gt;</th></tr>
</thead>
<tbody>
	<tr><td>(0.00488,0.0322]</td><td>0.02123323</td><td>0.02028734</td><td>0.001837447</td></tr>
	<tr><td>(0.0322,0.0592] </td><td>0.04397852</td><td>0.04411129</td><td>0.003283482</td></tr>
	<tr><td>(0.0592,0.0862] </td><td>0.06212914</td><td>0.07079371</td><td>0.004791716</td></tr>
	<tr><td>(0.0862,0.113]  </td><td>0.09860248</td><td>0.09884938</td><td>0.005880479</td></tr>
	<tr><td>(0.113,0.14]    </td><td>0.13122172</td><td>0.12331957</td><td>0.012769676</td></tr>
	<tr><td>(0.14,0.167]    </td><td>0.17391304</td><td>0.14635393</td><td>0.012283608</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>Next, we plot the observed vs expected proportions along with error bars. The red line indicates a perfect fit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">ggplot</span><span class="p">(</span><span class="n">calib_data</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_abline</span><span class="p">(</span><span class="n">intercept</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">slope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="s">&quot;red&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">  </span><span class="nf">geom_errorbar</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expected</span><span class="p">,</span><span class="w"> </span><span class="n">ymin</span><span class="o">=</span><span class="n">observed</span><span class="o">-</span><span class="n">se</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="o">=</span><span class="n">observed</span><span class="o">+</span><span class="n">se</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="o">=</span><span class="n">.</span><span class="m">01</span><span class="p">)</span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expected</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">observed</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5acd1e732a1fd263659e7cd3626929c672aaa69a250606543ff99099610d609b.png" src="../_images/5acd1e732a1fd263659e7cd3626929c672aaa69a250606543ff99099610d609b.png" />
</div>
</div>
</section>
<section id="variable-selection">
<h2>Variable Selection<a class="headerlink" href="#variable-selection" title="Permalink to this headline">#</a></h2>
<p>In the last chapter, we introduced the <code class="docutils literal notranslate"><span class="pre">step()</span></code> function to implement stepwise variable selection. This function also works with <code class="docutils literal notranslate"><span class="pre">glm</span></code> objects. In this case, we use this function to implement backward selection from a larger set of covariates. We first remove any observations with NA values to ensure that our training data does not change size as the formula changes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">nyts_sub</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nyts</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span>
<span class="w">  </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">location</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="p">,</span><span class="w"> </span><span class="n">grade</span><span class="p">,</span><span class="w"> </span><span class="n">otherlang</span><span class="p">,</span><span class="w"> </span><span class="n">grades_in_past_year</span><span class="p">,</span><span class="w"> </span><span class="n">perceived_e_cig_use</span><span class="p">,</span><span class="w"> </span>
<span class="w">                            </span><span class="n">race_and_ethnicity</span><span class="p">,</span><span class="w"> </span><span class="n">LGBT</span><span class="p">,</span><span class="w"> </span><span class="n">psych_distress</span><span class="p">,</span><span class="w"> </span><span class="n">family_affluence</span><span class="p">,</span><span class="w"> </span><span class="n">e_cig_use</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">  </span><span class="nf">na.omit</span><span class="p">()</span>
<span class="nf">head</span><span class="p">(</span><span class="n">nyts_sub</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A tibble: 6 × 11</caption>
<thead>
	<tr><th scope=col>location</th><th scope=col>sex</th><th scope=col>grade</th><th scope=col>otherlang</th><th scope=col>grades_in_past_year</th><th scope=col>perceived_e_cig_use</th><th scope=col>race_and_ethnicity</th><th scope=col>LGBT</th><th scope=col>psych_distress</th><th scope=col>family_affluence</th><th scope=col>e_cig_use</th></tr>
	<tr><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;fct&gt;</th><th scope=col>&lt;dbl&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;chr&gt;</th><th scope=col>&lt;fct&gt;</th></tr>
</thead>
<tbody>
	<tr><td>school</td><td>Male  </td><td>6th</td><td>No</td><td>Mostly A's</td><td>0</td><td>non-Hispanic White</td><td>No      </td><td>mild  </td><td>medium</td><td>0</td></tr>
	<tr><td>school</td><td>Female</td><td>6th</td><td>No</td><td>Mostly A's</td><td>0</td><td>non-Hispanic White</td><td>Not Sure</td><td>none  </td><td>high  </td><td>0</td></tr>
	<tr><td>school</td><td>Female</td><td>6th</td><td>No</td><td>Mostly C's</td><td>0</td><td>non-Hispanic Black</td><td>Yes     </td><td>severe</td><td>medium</td><td>0</td></tr>
	<tr><td>school</td><td>Female</td><td>6th</td><td>No</td><td>Mostly A's</td><td>0</td><td>non-Hispanic White</td><td>No      </td><td>none  </td><td>high  </td><td>0</td></tr>
	<tr><td>school</td><td>Female</td><td>6th</td><td>No</td><td>Mostly B's</td><td>0</td><td>Hispanic          </td><td>No      </td><td>none  </td><td>high  </td><td>0</td></tr>
	<tr><td>school</td><td>Male  </td><td>6th</td><td>No</td><td>Not Sure  </td><td>0</td><td>non-Hispanic White</td><td>No      </td><td>mild  </td><td>medium</td><td>0</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>To implement backward selection, we first create a model with all the covariates included. The period <code class="docutils literal notranslate"><span class="pre">.</span></code> in the formula indicates to include all variables. Next, we use the <code class="docutils literal notranslate"><span class="pre">step()</span></code> function. Since we are using backward selection, we only need to specify the lower formula in the scope.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">model_full</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">glm</span><span class="p">(</span><span class="n">e_cig_use</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nyts_sub</span><span class="p">,</span><span class="w"> </span><span class="n">family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binomial</span><span class="p">)</span>
<span class="n">mod_step</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="n">model_full</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;backward&#39;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                 </span><span class="n">scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="n">lower</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;e_cig_use ~ sex + grade + race_and_ethnicity + location&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Start:  AIC=6093.41
e_cig_use ~ location + sex + grade + otherlang + grades_in_past_year + 
    perceived_e_cig_use + race_and_ethnicity + LGBT + psych_distress + 
    family_affluence

                      Df Deviance    AIC
- family_affluence     2   6038.0 6090.0
&lt;none&gt;                     6037.4 6093.4
- otherlang            1   6042.5 6096.5
- LGBT                 2   6051.4 6103.4
- psych_distress       3   6105.5 6155.5
- grades_in_past_year  6   6126.2 6170.2
- perceived_e_cig_use  1   6415.5 6469.5

Step:  AIC=6090
e_cig_use ~ location + sex + grade + otherlang + grades_in_past_year + 
    perceived_e_cig_use + race_and_ethnicity + LGBT + psych_distress

                      Df Deviance    AIC
&lt;none&gt;                     6038.0 6090.0
- otherlang            1   6043.0 6093.0
- LGBT                 2   6051.7 6099.7
- psych_distress       3   6105.6 6151.6
- grades_in_past_year  6   6128.0 6168.0
- perceived_e_cig_use  1   6418.4 6468.4
</pre></div>
</div>
</div>
</div>
<p>Stepwise selection keeps most variables in the model and only drops family affluence. We can see the AUC for this model has improved to 0.818.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">roc_mod_step</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">roc</span><span class="p">(</span><span class="n">predictor</span><span class="o">=</span><span class="nf">predict</span><span class="p">(</span><span class="n">mod_step</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s">&quot;response&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">response</span><span class="o">=</span><span class="nf">as.factor</span><span class="p">(</span><span class="n">mod_step</span><span class="o">$</span><span class="n">y</span><span class="p">),</span><span class="w"> </span>
<span class="w">                    </span><span class="n">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&lt;&quot;</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">roc_mod_step</span><span class="p">,</span><span class="w"> </span><span class="n">print.auc</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">print.thres</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d516c068dda8494da9433a7e02156f984b62267757a93ce5e8c4b87515e5ecb9.png" src="../_images/d516c068dda8494da9433a7e02156f984b62267757a93ce5e8c4b87515e5ecb9.png" />
</div>
</div>
</section>
<section id="exercises">
<h2>Exercises:<a class="headerlink" href="#exercises" title="Permalink to this headline">#</a></h2>
<ol class="arabic simple">
<li><p>Try using <code class="docutils literal notranslate"><span class="pre">lm</span></code> for analyzing the smoking behavior as a function of variables in the <code class="docutils literal notranslate"><span class="pre">nyts</span></code> data. They can be random from your favorite or interested potential predictors. Fit a Logistic regression to your subset of data frame using <code class="docutils literal notranslate"><span class="pre">glm</span></code>. Are the estimated coefficients similar to the true ones we used?</p></li>
<li><p>What is the estimated probability of an event at x=1,1? Use <code class="docutils literal notranslate"><span class="pre">predict()</span></code> function but make sure to read the documentation on the type argument.</p></li>
<li><p>Measure accuracy and precision of your model.</p></li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            name: "ir",
            path: "./book"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="10_linear_regression.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">10. Linear Regression</p>
      </div>
    </a>
    <a class="right-next"
       href="12_rmarkdown_reports.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">12. Writing Reports with R Markdown</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#generalized-linear-models-in-r">Generalized Linear Models in R</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#residuals-discrimination-and-calibration">Residuals, Discrimination, and Calibration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#variable-selection">Variable Selection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises:</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alice Paul
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>