---
title: "Day3"
output: pdf_document
date: "2023-08-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

For these exercises, we will continue using the NHANESsample data.

```{r}
library(RforHDSdata) 
suppressPackageStartupMessages(library(tidyverse))
library(broom)
suppressPackageStartupMessages(library(car))
data(NHANESsample)
```


## Chapter 10 Exercise 1

Construct a linear model using `DBP` as the output and `LEAD`, `AGE`, and `EVER_SMOKE` as features, and print the output.

```{r}
NHANESsample$SBP <- apply(NHANESsample[,c("SBP1", "SBP2", "SBP3", "SBP4")], 1, 
                       function(x) case_when(sum(!is.na(x)) == 0 ~ NA, 
                                             sum(!is.na(x)) == 1 ~ mean(x, na.rm=TRUE),
                                             sum(!is.na(x)) > 1 ~ mean(x[-1], na.rm=TRUE))) 
NHANESsample$DBP <- apply(NHANESsample[,c("DBP1", "DBP2", "DBP3", "DBP4")], 1, 
                       function(x) case_when(sum(!is.na(x)) == 0 ~ NA, 
                                             sum(!is.na(x)) == 1 ~ mean(x, na.rm=TRUE),
                                             sum(!is.na(x)) > 1 ~ mean(x[-1], na.rm=TRUE)))                       
nhanes_df <- na.omit(subset(NHANESsample, select= -c(SBP1, SBP2, SBP3, SBP4, 
                                                     DBP1, DBP2, DBP3, DBP4)))

model_exercise1 <- lm(DBP~LEAD + AGE + SMOKE, data = nhanes_df)
summary(model_exercise1)
```


## Chapter 10 Exercise 2

Use forward stepwise selection to add interactions to the linear model from the previous question.

```{r}
model_int <- lm(DBP~ LEAD*AGE + LEAD*SMOKE + AGE*SMOKE, data = nhanes_df)
model_exercise2 <- step(model_exercise1, scope = list(lower = model_exercise1, upper = model_int), direction = "forward")
summary(model_exercise2)
```
## Chapter 10 Exercise 3

Draw a QQ plot for the model in Question 2, and describe the distribution that you observe.

```{r}
qqnorm(rstandard(model_exercise2)) 
qqline(rstandard(model_exercise2),col="red") 
```

## Chapter 10 Exercise 4

Report the MAE and MSE of the model developed in Question 2. Then, find the row numbers of the observations with the top 5 Cook's Distance values for this model.

```{r}
#first find the prediction by this model
predicted <- predict(model_exercise2)

#mae
mae <- mean(abs(nhanes_df$DBP - predicted))
cat('MAE: ', mae, '\n')

#mse
mse <- mean((nhanes_df$DBP- predicted)^2)
cat('MSE: ', mse, '\n')

#cooks distance
inf_mat <- influence.measures(model_exercise2)[['infmat']]
as.data.frame(inf_mat) %>% arrange(desc(cook.d)) %>% head()
```
## Chapter 10 Exercise 5

Look at some diagnostic plots for the model and use what you observe from these plots to choose a transformation that will improve the fit of this model. Then, fit and summarize this new model with the transformation included. How do the AIC and BIC of the new model compare to the previous one?

```{r}
model_exercise5 <- lm(log(DBP+1) ~ LEAD*AGE + LEAD*SMOKE + SMOKE*AGE, data=nhanes_df) 
summary(model_exercise5)

par(mfrow=c(2,2))
plot(model_exercise5)
```

## Chapter 10 Exercise 6